# 04 Pencil MCP 統合ワークフロー

Pencil MCP を使ったデザイン⇔コードの双方向ワークフローを定義する。

## 前提

- デザインファイル: `.pen` 形式（JSON ベース、Git 管理）
- AI エージェントは MCP 経由で `.pen` のベクターデータを読み取り、コードを生成する
- `.pen` はデザインの「視覚的表現」であり、正（Single Source of Truth）はコード側

## エージェント向け指示

- `.pen` からコードを生成する際は `src/styles/tokens.css` のトークンと `src/components/ui/` の既存コンポーネントを参照・再利用せよ。
- `.pen` 上にトークン外の値があった場合は、最も近いトークン値に丸めよ。
- Pencil レイヤーの命名をクラス名やコンポーネント構造のヒントとして活用せよ。
- 生成コードとデザインの間に乖離がある場合は報告せよ。

---

## ワークフロー

```
  .pen ファイル ──── MCP (read) ────→ AI エージェント
       ↑                                    │
       │            tokens.css              │
       │            components/    ← 参照 ──┘
       │                                    │
       └──────── MCP (write) ←──────────────┘
```

1. Pencil でデザインを作成・編集する
2. AI エージェントに指示する
3. AI が MCP 経由で `.pen` を読み取る
4. 既存トークン・コンポーネントを参照してコードを生成する
5. 必要に応じて AI が `.pen` 側を更新する（双方向）

---

## デザインファイル構成

```
design/
├── design-tokens.pen      トークンの視覚カタログ
├── components.pen         基盤コンポーネント一覧（全 Variant × Size）
├── screens/
│   ├── home.pen
│   ├── card-compose.pen
│   ├── timeline.pen
│   └── analytics.pen
└── brand-kit.pen          ロゴ・アイコン等
```

### `.pen` ファイル作成ルール

1. トークンで定義した値を使う。カラーピッカーで任意の色を使わない。
2. レイヤー名をセマンティックに命名する（kebab-case）。自動命名のまま放置しない。
3. 共通化すべき要素は Pencil 上でもコンポーネント化する。
4. モバイル（375px）とデスクトップ（1280px）の 2 パターンを用意する。

---

## プロンプト設計の原則

AI への指示で一貫して伝えるべきことを以下に定める。具体的なプロンプト文は、採用するフレームワーク・エージェントに応じてチームで整備する。

### 常に含めるべき制約

- `tokens.css` のトークンを使うこと（ハードコード禁止）
- 既存コンポーネントを確認し再利用すること
- レスポンシブは CSS Grid ベースで実装し、コンテナクエリの使用は最小限に留めよ。メディアクエリは使用しない。
- Pencil レイヤー名を参考にセマンティックな命名をすること

### 目的別の指示パターン

| 目的 | AI に伝えること |
|---|---|
| 画面のコード生成 | 対象の `.pen` ファイルパス + 上記の制約 |
| 単一コンポーネント生成 | `components.pen` 内の対象レイヤー名 + Variant/Size の網羅 |
| デザインの更新（コード→デザイン） | 変更されたコードファイル + 反映すべき変更内容 |
| トークン乖離チェック | `.pen` ファイル群をスキャンし、トークン外の値を一覧化 |

---

## AI ルールファイル

各エージェントのルールファイルにデザインシステムの制約を記載し、エージェントが自動的に読み込むようにする。

| エージェント | ルールファイル |
|---|---|
| Claude Code | `CLAUDE.md`（プロジェクトルート） |
| GitHub Copilot | `.github/copilot-instructions.md` |

記載すべき項目:

- プロダクトコンセプトへの参照（00-concept.md）
- トークン使用の義務（ハードコード禁止）
- 既存コンポーネントの確認・再利用ルール
- 命名規約
- Pencil 連携ルール（トークン外の値の丸め方、乖離の報告）
- レスポンシブ方針（CSS Grid ベース、コンテナクエリは最小限、メディアクエリ不使用）
- アクセシビリティの基本要件
- デザインシステムドキュメントの参照先パス

---

## 将来の移行パス

Pencil はまだ新しいツールであり、他ツールへの移行が必要になる可能性がある。以下の設計判断で移行コストを最小化している。

| 設計判断 | 移行を容易にする理由 |
|---|---|
| トークンは CSS 変数で管理 | ツール非依存。Figma Variables / Style Dictionary 等に変換可能 |
| コンポーネントはフレームワークのコードで実装 | デザインツールに依存しない |
| `.pen` は「視覚表現」であり「正」ではない | `.pen` を破棄してもコードに影響なし |
| 命名規約が統一されている | 別ツールでも同じ命名で再構築可能 |

保険として、トークンを DTCG（Design Tokens Community Group）形式の JSON でも管理しておくと、将来の変換が容易になる。
