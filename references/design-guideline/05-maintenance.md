# 05 保守・運用ルール

デザインシステムはプロダクトとともに育てる生きたシステムである。AI 生成コードを多用する開発では、品質のドリフト（逸脱）を防ぐ仕組みが特に重要になる。

## エージェント向け指示

- トークンやコンポーネントを変更・追加した場合は、対応するドキュメント（01-tokens.md, 02-components.md）の更新も行え。
- 既存トークンやコンポーネントの削除は、影響範囲を報告してから行え。

---

## Git 管理

### ブランチ命名

| 変更内容 | ブランチ命名 | 理由 |
|---|---|---|
| トークン変更 | `ds/token-{内容}` | 影響範囲が大きいため分離 |
| 基盤コンポーネント変更 | `ds/component-{名前}` | |
| ドメインコンポーネント変更 | `feature/{機能名}` | 通常の機能ブランチに含める |
| `.pen` ファイルのみの変更 | `ds/design-{画面名}` | |

### PR ルール

- `.pen` ファイルの変更を含む PR にはスクリーンショットを添付する。
- `tokens.css` の変更を含む PR には影響を受けるコンポーネント・画面の一覧を本文に記載する。
- 基盤コンポーネント（L2）の追加時は `02-components.md` の更新をセットで行う。

### コードレビューの DS チェックポイント

```
□ ハードコードされた色値が含まれていないか
□ トークンに定義されていない余白値が使われていないか
□ 既存コンポーネントで代替できるのに新規作成していないか
□ 命名規約に従っているか
□ Pencil レイヤー名がセマンティックか（自動命名のまま残っていないか）
□ レスポンシブが CSS Grid ベースになっているか（不要なコンテナクエリやメディアクエリがないか）
```

---

## スプリント棚卸し

2 週間スプリントの振り返りで DS 健全性チェックを実施する（10〜15 分）。

### チェックリスト

```
□ ハードコード値が新規コードに混入していないか
□ 新しく作った共通パーツが components/ui/ に切り出されているか
□ .pen ファイルが最新のコードと同期しているか
□ AI ルールファイルに追記すべきルールがないか
□ 未使用のトークンやコンポーネントがないか
□ AI 生成コードの品質傾向に変化はないか
```

### 判断基準

| 発見事項 | アクション |
|---|---|
| あるパターンが 2 箇所以上で使われている | L2 or L3 コンポーネントへの昇格を検討 |
| トークンにない値がハードコードされている | トークン追加 or 既存トークンへの丸め |
| 1 箇所でしか使われないコンポーネント | ページ内インライン定義のまま。components/ に入れない |
| 使われなくなったトークン / コンポーネント | 影響範囲を確認の上、削除を検討 |

---

## AI 精度の改善サイクル

### 評価

AI 生成コードを 3 段階で評価し、スプリントごとに傾向を記録する。

| 評価 | 定義 | 目標割合 |
|---|---|---|
| A | そのまま使える | 60% 以上 |
| B | 微調整で使える | 30% 以下 |
| C | 書き直しが必要 | 10% 以下 |

### 改善アクション

| AI の問題パターン | 対処 |
|---|---|
| 特定の値をハードコードしがち | AI ルールファイルに禁止ルールを追記 |
| 既存コンポーネントを使わず新規作成する | ルールファイルにコンポーネント一覧を追記 |
| 命名が規約に合わない | 具体例をルールファイルに追記 |
| レスポンシブが不十分 | Grid ベースの設計とコンテナクエリの使い方をルールファイルに追記 |

AI ルールファイルの品質が以後すべての AI 生成コードの品質を決定するため、改善サイクルの中で最も重要な成果物として扱う。

---

## トークン・コンポーネントの変更手順

### トークン追加

1. `tokens.css` に CSS 変数を追加
2. `01-tokens.md` に定義を追記
3. `design-tokens.pen` を更新
4. PR でレビュー

### トークン変更

1. 影響を受けるコンポーネント・画面を検索で洗い出す
2. `ds/token-*` ブランチで変更
3. 影響箇所の見た目を確認
4. ドキュメントと `.pen` を更新
5. PR にスクリーンショット（変更前後）を添付

### トークン削除

1. 使用箇所がゼロであることを確認
2. 使用箇所がある場合は代替トークンへの移行を先に実施
3. `tokens.css`・ドキュメント・`.pen` から削除

### 基盤コンポーネント（L2）の変更

破壊的変更がある場合はチームに事前共有する。使用箇所を洗い出し、すべての画面で見た目が崩れないことを確認する。`02-components.md` と `components.pen` の更新を忘れないこと。

---

## スケール戦略

### ダークモード（将来）

Semantic カラーと Primitive カラーを分離しているため、Semantic 層の参照先を切り替えるだけで対応可能。コンポーネント側の変更は不要。

### 多言語対応（将来）

UI 文言をコンポーネントにハードコードせず、外部から渡す設計にしておくと i18n 対応が容易になる。

### Pencil からの移行（将来）

`tokens.css` とコンポーネントコードはツール非依存のため、`.pen` を破棄してもプロダクトに影響しない。DTCG 形式の JSON でもトークンを管理しておくと、Style Dictionary 等への変換がスムーズになる。
